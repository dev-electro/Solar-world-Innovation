<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Plant Viability Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for capturing DOM elements -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            cursor: pointer;
            border-radius: 50%;
            margin-top: -9px; /* Centers the thumb on the track */
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #d1d5db;
            border-radius: 3px;
            outline: none;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Style for the toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34d399;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34d399;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="report-container" class="w-full max-w-5xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="p-8 bg-gradient-to-br from-emerald-500 to-teal-600 text-white relative overflow-hidden">
                 <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
                 <div class="absolute -bottom-16 -left-10 w-48 h-48 bg-white/10 rounded-full"></div>
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight relative">Solar Plant Viability Calculator</h1>
                <p class="mt-4 text-teal-100 text-lg relative">A comprehensive tool for project investment analysis.</p>
            </div>

            <!-- Toggle Switch for Collapsible sections -->
            <div class="p-4 sm:p-6 border-b border-slate-200 flex justify-end items-center gap-3">
                <label for="collapsible-toggle" class="text-sm font-medium text-slate-700">Enable Collapsible Sections</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="collapsible-toggle" id="collapsible-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="collapsible-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>

            <div class="p-4 sm:p-6 md:p-8 space-y-6">
                <!-- Accordion Items -->
                <!-- 1. Cost of Plant -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <button class="accordion-toggle w-full flex justify-between items-center p-5 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 transition" data-target="#cost-section">
                        <span>1. Cost of Plant</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="cost-section" class="accordion-content">
                        <div class="p-5 border-t border-slate-200 grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="capacity" class="text-sm font-medium text-gray-600">Total Plant Capacity (KW)</label>
                                <input type="number" id="capacity" value="1000" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div>
                                <label for="panel_cost" class="text-sm font-medium text-gray-600">Cost of Panels (per Watt)</label>
                                <input type="number" id="panel_cost" value="25" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div>
                                <label for="discount" class="text-sm font-medium text-gray-600">Total Discount on Panels (₹)</label>
                                <input type="number" id="discount" value="0" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div>
                                <label for="structure_cost" class="text-sm font-medium text-gray-600">Cost of Structure (if separate) (₹)</label>
                                <input type="number" id="structure_cost" value="0" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div class="sm:col-span-2 mt-4 p-5 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="font-semibold text-blue-800">Total Plant Cost:</h3>
                                <p id="total_cost" class="text-3xl font-bold text-blue-600">₹0.00</p>
                                <p id="total_cost_words" class="text-sm text-blue-500 italic"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Cost of Funding -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <button class="accordion-toggle w-full flex justify-between items-center p-5 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 transition" data-target="#funding-section">
                        <span>2. Cost of Funding</span>
                         <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="funding-section" class="accordion-content">
                         <div class="p-5 border-t border-slate-200 space-y-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <label for="self_fund" class="text-sm font-medium text-gray-600">Self Fund (₹)</label>
                                    <input type="number" id="self_fund" value="0" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Total Loan Amount (₹)</label>
                                    <p id="loan_amount" class="mt-1 w-full p-3 rounded-lg bg-slate-100 text-slate-800 font-medium">₹0.00</p>
                                    <p id="loan_amount_words" class="text-sm text-slate-500 italic"></p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label for="interest_rate" class="text-sm font-medium text-gray-600">Interest Rate (% p.a.) - <span id="interest_rate_val" class="font-bold text-blue-600">6.0%</span></label>
                                <input type="range" id="interest_rate" min="5" max="15" step="0.1" value="6">
                            </div>
                             <div class="space-y-2">
                                <label for="loan_tenure" class="text-sm font-medium text-gray-600">Loan Tenure (Years) - <span id="loan_tenure_val" class="font-bold text-blue-600">7 Years</span></label>
                                <input type="range" id="loan_tenure" min="1" max="25" step="1" value="7">
                            </div>
                            <div class="mt-4 p-5 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="font-semibold text-blue-800">Monthly EMI on Loan:</h3>
                                <p id="monthly_emi" class="text-3xl font-bold text-blue-600">₹0.00</p>
                                <p id="monthly_emi_words" class="text-sm text-blue-500 italic"></p>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- 3. O&M Costs -->
                 <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <button class="accordion-toggle w-full flex justify-between items-center p-5 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 transition" data-target="#om-section">
                        <span>3. Operation & Maintenance Costs</span>
                         <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="om-section" class="accordion-content">
                        <div class="p-5 border-t border-slate-200 grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                               <label for="required_land" class="text-sm font-medium text-gray-600">Required Land (Bigha)</label>
                               <input type="number" id="required_land" value="6" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div>
                               <label for="rental_cost_bigha" class="text-sm font-medium text-gray-600">Rental Cost (per Bigha/month) (₹)</label>
                               <input type="number" id="rental_cost_bigha" value="2000" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div class="sm:col-span-2 p-3 bg-slate-100 rounded-lg">
                                <h4 class="font-medium text-slate-600">Total Monthly Rental Cost:</h4>
                                <p id="total_rental_cost" class="font-bold text-slate-800">₹0.00</p>
                                <p id="total_rental_cost_words" class="text-xs text-slate-500 italic"></p>
                            </div>
                            <div>
                                <label for="security_guards" class="text-sm font-medium text-gray-600">No. of Security Guards</label>
                                <input type="number" id="security_guards" value="3" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                             <div>
                                <label for="guard_salary" class="text-sm font-medium text-gray-600">Security Guard Salary (monthly) (₹)</label>
                                <input type="number" id="guard_salary" value="15000" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                             <div>
                                <label for="engineers" class="text-sm font-medium text-gray-600">No. of Engineers</label>
                                <input type="number" id="engineers" value="1" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                             <div>
                                <label for="engineer_salary" class="text-sm font-medium text-gray-600">Engineer Salary (monthly) (₹)</label>
                                <input type="number" id="engineer_salary" value="15000" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                             <div class="sm:col-span-2">
                                <label for="misc_cost" class="text-sm font-medium text-gray-600">Other Miscellaneous Cost (monthly) (₹)</label>
                                <input type="number" id="misc_cost" value="16000" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div class="sm:col-span-2 mt-4 p-5 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="font-semibold text-blue-800">Total Monthly O&M Cost:</h3>
                                <p id="om_cost" class="text-3xl font-bold text-blue-700">₹0.00</p>
                                <p id="om_cost_words" class="text-sm text-blue-600 italic"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Generation & Income -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                     <button class="accordion-toggle w-full flex justify-between items-center p-5 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 transition" data-target="#income-section">
                        <span>4. Generation & Income</span>
                         <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="income-section" class="accordion-content">
                        <div class="p-5 border-t border-slate-200 grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="generation" class="text-sm font-medium text-gray-600">Generation (units per KW per day)</label>
                                <input type="number" id="generation" value="4.5" step="0.1" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div>
                                <label for="income_per_unit" class="text-sm font-medium text-gray-600">Income per Unit (₹)</label>
                                <input type="number" id="income_per_unit" value="3.04" step="0.01" class="mt-1 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                            </div>
                            <div class="sm:col-span-2 mt-4 p-5 bg-green-50 border-green-200 border rounded-lg grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div>
                                    <h3 class="font-semibold text-green-800">Total Monthly Income:</h3>
                                    <p id="monthly_income" class="text-3xl font-bold text-green-600">₹0.00</p>
                                    <p id="monthly_income_words" class="text-sm text-green-500 italic"></p>
                                </div>
                                 <div>
                                    <h3 class="font-semibold text-green-800">Total Yearly Income:</h3>
                                    <p id="yearly_income" class="text-3xl font-bold text-green-600">₹0.00</p>
                                    <p id="yearly_income_words" class="text-sm text-green-500 italic"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 5. 25-Year Lifecycle Analysis -->
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <button class="accordion-toggle w-full flex justify-between items-center p-5 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 transition" data-target="#longterm-section">
                        <span>5. 25-Year Lifecycle Analysis</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="longterm-section" class="accordion-content">
                        <div class="p-5 border-t border-slate-200 space-y-5">
                            <div class="p-5 bg-slate-100 rounded-lg">
                                <h3 class="font-semibold text-slate-700">Simple Payback Period:</h3>
                                <p id="payback_period" class="text-2xl font-bold text-slate-800">Calculating...</p>
                                <p class="text-xs text-slate-500 italic">Time to recover the total initial plant cost.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div id="loan_period_profit_box" class="p-5 rounded-lg">
                                    <h3 id="loan_period_profit_label" class="font-semibold"></h3>
                                     <p id="loan_period_profit" class="text-2xl font-bold">₹0.00</p>
                                     <p id="loan_period_profit_words" class="text-sm italic"></p>
                                </div>
                                <div class="p-5 bg-green-50 border border-green-200 rounded-lg">
                                    <h3 class="font-semibold text-green-800">Net Profit (Post-Loan Period)</h3>
                                    <p id="post_loan_profit" class="text-2xl font-bold text-green-700">₹0.00</p>
                                    <p id="post_loan_profit_words" class="text-sm text-green-600 italic"></p>
                                </div>
                            </div>
                             <div class="mt-4 p-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-center shadow-lg">
                                <h3 class="font-semibold opacity-80">Total Estimated Profit over 25 Years</h3>
                                <p id="total_25_year_profit" class="text-4xl font-bold mt-1">₹0.00</p>
                                <p id="total_25_year_profit_words" class="opacity-70 text-sm italic"></p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 6. Viability Test -->
                <div class="pt-6">
                    <div class="bg-gray-800 rounded-xl p-6 sm:p-8 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute -top-12 -left-12 w-64 h-64 bg-gradient-to-br from-gray-700 to-gray-800 rounded-full opacity-50 hidden sm:block"></div>
                        <div class="absolute -bottom-20 -right-10 w-72 h-72 bg-gradient-to-br from-gray-700 to-gray-800 rounded-full opacity-50 hidden sm:block"></div>
                        
                        <div class="relative">
                             <h2 class="text-3xl font-bold text-center mb-6">6. Monthly Viability Test</h2>
                            <div class="flex flex-col sm:flex-row items-center justify-around gap-4 sm:gap-0">
                                <div class="text-center">
                                    <p class="text-green-300 text-sm uppercase tracking-wider">Income</p>
                                    <p id="summary_income" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-green-400">₹0.00</p>
                                    <p id="summary_income_words" class="text-sm text-green-400/70 italic"></p>
                                </div>
                                 <div class="text-4xl font-thin text-gray-500 self-center my-2 sm:my-0">-</div>
                                <div class="text-center">
                                     <p class="text-red-300 text-sm uppercase tracking-wider">Total Costs</p>
                                    <p id="summary_costs" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-red-400">₹0.00</p>
                                    <p id="summary_costs_words" class="text-sm text-red-400/70 italic"></p>
                                </div>
                            </div>
                            <div class="mt-8 pt-6 border-t border-gray-700 text-center">
                                <p class="text-gray-300 text-lg">Overall Monthly Financial Position</p>
                                <p id="viability_result" class="text-4xl sm:text-5xl lg:text-6xl font-extrabold mt-2 text-transparent bg-clip-text">--</p>
                                 <p id="viability_result_words" class="text-lg text-gray-300 italic"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 px-4">
             <button id="download-btn" class="w-full sm:w-auto bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                Download Report as PDF
            </button>
            <p class="text-sm text-gray-500 mt-4">This calculator provides an estimate for viability assessment. Consult with a financial advisor for detailed analysis.</p>
        </footer>
    </div>

    <script>
        // --- DOM Element Selection ---
        const allInputs = Array.from(document.querySelectorAll('input'));
        const elements = {
            collapsibleToggle: document.getElementById('collapsible-toggle'),
            downloadBtn: document.getElementById('download-btn'),
            // Section 1
            capacity: document.getElementById('capacity'),
            panelCost: document.getElementById('panel_cost'),
            discount: document.getElementById('discount'),
            structureCost: document.getElementById('structure_cost'),
            totalCost: document.getElementById('total_cost'),
            totalCostWords: document.getElementById('total_cost_words'),
            // Section 2
            selfFund: document.getElementById('self_fund'),
            loanAmount: document.getElementById('loan_amount'),
            loanAmountWords: document.getElementById('loan_amount_words'),
            interestRate: document.getElementById('interest_rate'),
            interestRateVal: document.getElementById('interest_rate_val'),
            loanTenure: document.getElementById('loan_tenure'),
            loanTenureVal: document.getElementById('loan_tenure_val'),
            monthlyEmi: document.getElementById('monthly_emi'),
            monthlyEmiWords: document.getElementById('monthly_emi_words'),
            // Section 3
            requiredLand: document.getElementById('required_land'),
            rentalCostBigha: document.getElementById('rental_cost_bigha'),
            totalRentalCost: document.getElementById('total_rental_cost'),
            totalRentalCostWords: document.getElementById('total_rental_cost_words'),
            securityGuards: document.getElementById('security_guards'),
            guardSalary: document.getElementById('guard_salary'),
            engineers: document.getElementById('engineers'),
            engineerSalary: document.getElementById('engineer_salary'),
            miscCost: document.getElementById('misc_cost'),
            omCost: document.getElementById('om_cost'),
            omCostWords: document.getElementById('om_cost_words'),
            // Section 4
            generation: document.getElementById('generation'),
            incomePerUnit: document.getElementById('income_per_unit'),
            monthlyIncome: document.getElementById('monthly_income'),
            monthlyIncomeWords: document.getElementById('monthly_income_words'),
            yearlyIncome: document.getElementById('yearly_income'),
            yearlyIncomeWords: document.getElementById('yearly_income_words'),
            // Section 5
            paybackPeriod: document.getElementById('payback_period'),
            loanPeriodProfitBox: document.getElementById('loan_period_profit_box'),
            loanPeriodProfitLabel: document.getElementById('loan_period_profit_label'),
            loanPeriodProfit: document.getElementById('loan_period_profit'),
            loanPeriodProfitWords: document.getElementById('loan_period_profit_words'),
            postLoanProfit: document.getElementById('post_loan_profit'),
            postLoanProfitWords: document.getElementById('post_loan_profit_words'),
            total25YearProfit: document.getElementById('total_25_year_profit'),
            total25YearProfitWords: document.getElementById('total_25_year_profit_words'),
            // Section 6
            summaryIncome: document.getElementById('summary_income'),
            summaryIncomeWords: document.getElementById('summary_income_words'),
            summaryCosts: document.getElementById('summary_costs'),
            summaryCostsWords: document.getElementById('summary_costs_words'),
            viabilityResult: document.getElementById('viability_result'),
            viabilityResultWords: document.getElementById('viability_result_words'),
        };

        // --- Helper Functions ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(value);
        
        function numberToWords(num) {
            if (isNaN(num)) return '';
            const absNum = Math.abs(Math.floor(num));
            if (absNum < 100000) return `(${absNum.toLocaleString('en-IN')})`;
            if (absNum < 10000000) return `(${(absNum / 100000).toFixed(2)} Lakh)`;
            return `(${(absNum / 10000000).toFixed(2)} Crore)`;
        }

        function handleCapacityChange() {
             const capacityKW = parseFloat(elements.capacity.value) || 0;
             // Auto-update land requirement: 6 Bigha per 1000 KW
             const requiredLandVal = (capacityKW / 1000) * 6;
             elements.requiredLand.value = requiredLandVal.toFixed(2);
             calculateViability();
        }

        // --- Main Calculation Function ---
        function calculateViability() {
            // --- 1. Calculate Total Plant Cost ---
            const capacityKW = parseFloat(elements.capacity.value) || 0;
            const panelCostPerWatt = parseFloat(elements.panelCost.value) || 0;
            const totalDiscount = parseFloat(elements.discount.value) || 0;
            const structureCost = parseFloat(elements.structureCost.value) || 0;
            const totalPanelCost = (capacityKW * 1000) * panelCostPerWatt;
            const discountedPanelCost = Math.max(0, totalPanelCost - totalDiscount);
            const totalPlantCost = discountedPanelCost + structureCost;
            elements.totalCost.textContent = formatCurrency(totalPlantCost);
            elements.totalCostWords.textContent = numberToWords(totalPlantCost);

            // --- 2. Calculate Funding and EMI ---
            const selfFundAmount = parseFloat(elements.selfFund.value) || 0;
            const loanAmountVal = Math.max(0, totalPlantCost - selfFundAmount);
            elements.loanAmount.textContent = formatCurrency(loanAmountVal);
            elements.loanAmountWords.textContent = numberToWords(loanAmountVal);
            const interestRateVal = parseFloat(elements.interestRate.value);
            const loanTenureVal = parseInt(elements.loanTenure.value);
            elements.interestRateVal.textContent = `${interestRateVal.toFixed(1)}%`;
            elements.loanTenureVal.textContent = `${loanTenureVal} Years`;
            const monthlyInterestRate = interestRateVal / 12 / 100;
            const numberOfMonths = loanTenureVal * 12;
            let monthlyEmiVal = 0;
            if (loanAmountVal > 0 && monthlyInterestRate > 0 && numberOfMonths > 0) {
                 monthlyEmiVal = loanAmountVal * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfMonths) / (Math.pow(1 + monthlyInterestRate, numberOfMonths) - 1);
            }
            elements.monthlyEmi.textContent = formatCurrency(monthlyEmiVal);
            elements.monthlyEmiWords.textContent = numberToWords(monthlyEmiVal);

            // --- 3. Calculate O&M Costs ---
            const monthlyRentalCost = (parseFloat(elements.rentalCostBigha.value) || 0) * (parseFloat(elements.requiredLand.value) || 0);
            elements.totalRentalCost.textContent = formatCurrency(monthlyRentalCost);
            elements.totalRentalCostWords.textContent = numberToWords(monthlyRentalCost);

            const guardCost = (parseFloat(elements.securityGuards.value) || 0) * (parseFloat(elements.guardSalary.value) || 0);
            const engineerCost = (parseFloat(elements.engineers.value) || 0) * (parseFloat(elements.engineerSalary.value) || 0);
            const miscCost = parseFloat(elements.miscCost.value) || 0;
            const totalOMCost = monthlyRentalCost + guardCost + engineerCost + miscCost;
            elements.omCost.textContent = formatCurrency(totalOMCost);
            elements.omCostWords.textContent = numberToWords(totalOMCost);

            // --- 4. Calculate Generation & Income ---
            const dailyGeneration = (parseFloat(elements.generation.value) || 0) * capacityKW;
            const incomePerUnitVal = parseFloat(elements.incomePerUnit.value) || 0;
            const monthlyIncomeVal = dailyGeneration * 30 * incomePerUnitVal;
            const yearlyIncomeVal = monthlyIncomeVal * 12;
            elements.monthlyIncome.textContent = formatCurrency(monthlyIncomeVal);
            elements.monthlyIncomeWords.textContent = numberToWords(monthlyIncomeVal);
            elements.yearlyIncome.textContent = formatCurrency(yearlyIncomeVal);
            elements.yearlyIncomeWords.textContent = numberToWords(yearlyIncomeVal);


            // --- 5. Calculate Monthly Viability ---
            const totalMonthlyCosts = monthlyEmiVal + totalOMCost;
            const netMonthlyPosition = monthlyIncomeVal - totalMonthlyCosts;
            elements.summaryIncome.textContent = formatCurrency(monthlyIncomeVal);
            elements.summaryIncomeWords.textContent = numberToWords(monthlyIncomeVal);
            elements.summaryCosts.textContent = formatCurrency(totalMonthlyCosts);
            elements.summaryCostsWords.textContent = numberToWords(totalMonthlyCosts);

            if (netMonthlyPosition > 0) {
                elements.viabilityResult.textContent = `Profit: ${formatCurrency(netMonthlyPosition)}`;
                elements.viabilityResult.className = 'text-4xl sm:text-5xl lg:text-6xl font-extrabold mt-2 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-400';
            } else {
                elements.viabilityResult.textContent = `Loss: ${formatCurrency(Math.abs(netMonthlyPosition))}`;
                 elements.viabilityResult.className = 'text-4xl sm:text-5xl lg:text-6xl font-extrabold mt-2 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-rose-500';
            }
            elements.viabilityResultWords.textContent = numberToWords(netMonthlyPosition);


            // --- 6. Calculate Long-Term Viability (25 Years) ---
            const plantLifespanMonths = 25 * 12;
            const postLoanMonths = Math.max(0, plantLifespanMonths - numberOfMonths);
            const postLoanMonthlyProfit = monthlyIncomeVal - totalOMCost;
            const loanPeriodTotalProfit = netMonthlyPosition * numberOfMonths;
            const postLoanTotalProfit = postLoanMonthlyProfit * postLoanMonths;
            const total25YearProfitVal = loanPeriodTotalProfit + postLoanTotalProfit;
            
            // Payback Period Calculation
            let monthsToPayback = 0;
            if (totalPlantCost > 0 && (netMonthlyPosition > 0 || (netMonthlyPosition <= 0 && postLoanMonthlyProfit > 0))) {
                let cumulativeProfit = 0;
                for (let m = 1; m <= plantLifespanMonths; m++) {
                    cumulativeProfit += (m <= numberOfMonths) ? netMonthlyPosition : postLoanMonthlyProfit;
                    if (cumulativeProfit >= totalPlantCost) {
                        monthsToPayback = m;
                        break;
                    }
                }
            }
            let paybackText = 'Payback not achievable under current conditions.';
            if (totalPlantCost === 0) paybackText = 'N/A (No initial cost)';
            else if (monthsToPayback > 0) {
                const paybackYears = Math.floor(monthsToPayback / 12);
                const paybackMonths = monthsToPayback % 12;
                paybackText = `${paybackYears} Years and ${paybackMonths} Months`;
            }
            
            // Update UI for Long-Term Analysis
            elements.paybackPeriod.textContent = paybackText;

            if(loanPeriodTotalProfit >= 0){
                elements.loanPeriodProfitLabel.textContent = "Net Profit (During Loan Period)";
                elements.loanPeriodProfit.textContent = formatCurrency(loanPeriodTotalProfit);
                elements.loanPeriodProfit.className = "text-2xl font-bold text-green-700";
                elements.loanPeriodProfitWords.className = "text-sm text-green-600 italic"
                elements.loanPeriodProfitBox.className = "p-5 rounded-lg bg-green-50 border border-green-200";
            } else {
                elements.loanPeriodProfitLabel.textContent = "Total Out-of-Pocket (During Loan)";
                elements.loanPeriodProfit.textContent = formatCurrency(Math.abs(loanPeriodTotalProfit));
                elements.loanPeriodProfit.className = "text-2xl font-bold text-red-700";
                elements.loanPeriodProfitWords.className = "text-sm text-red-600 italic"
                elements.loanPeriodProfitBox.className = "p-5 rounded-lg bg-red-50 border border-red-200";
            }
            elements.loanPeriodProfitWords.textContent = numberToWords(loanPeriodTotalProfit);
            
            elements.postLoanProfit.textContent = formatCurrency(postLoanTotalProfit);
            elements.postLoanProfitWords.textContent = numberToWords(postLoanTotalProfit);

            elements.total25YearProfit.textContent = formatCurrency(total25YearProfitVal);
            elements.total25YearProfitWords.textContent = numberToWords(total25YearProfitVal);
        }
        
        // --- Accordion Logic ---
        function toggleAllAccordions(expand) {
            document.querySelectorAll('.accordion-content').forEach(content => {
                const button = content.previousElementSibling;
                const icon = button.querySelector('svg');
                if (expand) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.classList.add('rotate-180');
                } else {
                    content.style.maxHeight = null;
                    icon.classList.remove('rotate-180');
                }
            });
        }
        
        // --- PDF Download Logic ---
        function downloadReport() {
            const { jsPDF } = window.jspdf;
            const reportElement = document.getElementById('report-container');
            const downloadButton = elements.downloadBtn;
            
            downloadButton.textContent = 'Generating...';
            downloadButton.disabled = true;

            // Ensure all sections are expanded for the PDF
            const wasCollapsed = elements.collapsibleToggle.checked;
            if (wasCollapsed) {
                toggleAllAccordions(true);
            }

            html2canvas(reportElement, {
                scale: 2, // Improve resolution
                useCORS: true,
                logging: false,
                onclone: (document) => {
                    // Hide the download button in the clone
                    document.getElementById('download-btn').style.display = 'none';
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                const imgWidth = pdfWidth;
                const imgHeight = imgWidth / ratio;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                pdf.save('Solar_Viability_Report.pdf');

                // Restore accordion state if it was changed
                if (wasCollapsed) {
                    toggleAllAccordions(false);
                }
                
                downloadButton.textContent = 'Download Report as PDF';
                downloadButton.disabled = false;
            }).catch(err => {
                 console.error("Error generating PDF:", err);
                 // Restore accordion state if it was changed
                if (wasCollapsed) {
                    toggleAllAccordions(false);
                }
                 downloadButton.textContent = 'Download Report as PDF';
                 downloadButton.disabled = false;
            });
        }

        // --- Event Listeners ---
        // Listener for the main toggle switch
        elements.collapsibleToggle.addEventListener('change', () => {
            if (!elements.collapsibleToggle.checked) {
                toggleAllAccordions(true); // Expand all
            } else {
                 toggleAllAccordions(false); // Collapse all
                 // Optionally open the first one
                 const firstContent = document.querySelector('.accordion-content');
                 if(firstContent) {
                     const button = firstContent.previousElementSibling;
                     const icon = button.querySelector('svg');
                     firstContent.style.maxHeight = firstContent.scrollHeight + 'px';
                     icon.classList.add('rotate-180');
                 }
            }
        });

        // Listener for individual accordion buttons
        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                if (!elements.collapsibleToggle.checked) return; // Do nothing if collapsible is disabled

                const content = document.querySelector(button.dataset.target);
                const icon = button.querySelector('svg');
                const isOpening = !content.style.maxHeight;

                // Close all others
                document.querySelectorAll('.accordion-content').forEach(item => {
                    item.style.maxHeight = null;
                    item.previousElementSibling.querySelector('svg').classList.remove('rotate-180');
                });
                
                // Open the clicked one if it was closed
                if (isOpening) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.classList.add('rotate-180');
                }
            });
        });

        // Specific listener for capacity to auto-update land
        elements.capacity.addEventListener('input', handleCapacityChange);
        
        // General listeners for all other inputs
        allInputs.forEach(input => {
            if(input.id !== 'capacity') {
                input.addEventListener('input', calculateViability)
            }
        });

        // PDF Download button listener
        elements.downloadBtn.addEventListener('click', downloadReport);

        // Initial setup on page load
        window.addEventListener('load', () => {
            toggleAllAccordions(true); // Start with all sections expanded
            handleCapacityChange(); // Run initial calculation
        });
    </script>
</body>
</html>
